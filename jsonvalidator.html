<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Diff Page with Manual Input + Validation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f9fb;
      padding-bottom: 50px;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h1 {
      font-weight: normal;
      font-size: 24px;
      color: #333;
      margin-top: 0;
      text-align: center;
    }
    h2 {
      font-size: 18px;
      margin: 20px 0 10px;
    }
    .section {
      margin-top: 20px;
    }
    label {
      display: inline-block;
      font-weight: bold;
      margin-right: 10px;
      margin-top: 6px;
    }
    .raw-response {
      background: #f7f7f7;
      padding: 10px;
      border: 1px solid #ddd;
      height: 150px;
      overflow: auto;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .btn {
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .diff-output {
      background: #f7f7f7;
      padding: 10px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      font-size: 14px;
      margin-top: 10px;
      outline: none;
    }
    .diff-added {
      background-color: #d4ffd4;
    }
    .diff-removed {
      background-color: #ffecec;
      text-decoration: line-through;
    }
    .field-block {
      margin-bottom: 10px;
    }
    .object-block, .array-block {
      border-left: 2px solid #ddd;
      margin-left: 20px;
      padding-left: 10px;
      margin-top: 10px;
    }
    .field-label {
      font-weight: bold;
      margin-right: 4px;
    }
    .add-btn {
      margin-left: 10px;
      background: #28a745;
      cursor: pointer;
      color: #fff;
      font-size: 12px;
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
    }
    .remove-btn {
      margin-left: 10px;
      background: #dc3545;
      cursor: pointer;
      color: #fff;
      font-size: 12px;
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
    }
    .api-inputs {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .api-inputs label {
      margin: 0;
    }
    .api-inputs input {
      width: 150px;
      padding: 3px;
      font-size: 14px;
    }
    .error {
      color: #d9534f;
      font-weight: bold;
    }
    .error-list {
      color: #d9534f;
      margin-top: 10px;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .collapse-controls {
      margin-bottom: 15px;
    }
    .toggle-btn {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 12px;
      margin-right: 5px;
      cursor: pointer;
      padding: 2px 5px;
    }
    .toggle-btn:hover {
      background: #e0e0e0;
    }
    .collapsed > .object-block, 
    .collapsed > .array-block {
      display: none;
    }
    .collapsed > .field-block > .object-block,
    .collapsed > .field-block > .array-block {
      display: none;
    }
    .collapsed > .placeholder {
      display: inline-block;
      color: #666;
      font-style: italic;
      margin-left: 5px;
    }
    .placeholder {
      display: none;
    }
    .diff-container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      margin-bottom: 30px;
    }
    .diff-side {
      flex: 1;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      max-height: 800px;
      overflow: auto;
      padding: 10px;
      padding-right: 20px;
    }
    .json-display {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      margin: 0;
      min-height: 750px;
    }
    .diff-markers-container {
      position: absolute;
      top: 0;
      right: 0;
      width: 12px;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .diff-marker {
      position: absolute;
      right: 0;
      width: 8px;
      height: 3px;
      border-radius: 1px;
      cursor: pointer;
      pointer-events: auto;
      z-index: 15;
    }
    .diff-marker:hover {
      width: 10px;
      height: 4px;
    }
    .diff-marker.added {
      background-color: #28a745;
    }
    .diff-marker.removed {
      background-color: #d73a49;
    }
    .diff-highlight {
      background-color: rgba(255, 255, 0, 0.3) !important;
      transition: background-color 0.5s ease-out;
    }
    .review-inputs {
      margin-bottom: 15px;
    }
    .review-inputs > div {
      margin-bottom: 8px;
    }
    .approve-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .approve-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .approve-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .api-select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
      font-size: 14px;
      background-color: white;
    }
    .api-select:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 3px rgba(74, 144, 226, 0.3);
    }
    .diff-side h3 {
      position: sticky;
      top: 0;
      background-color: #f9f9f9;
      margin-top: 0;
      padding: 5px 0;
      z-index: 5;
      border-bottom: 1px solid #eee;
    }
    /* Line number styling */
    .diff-with-line-numbers {
      display: flex;
      width: 100%;
    }
    
    .line-numbers {
      user-select: none;
      text-align: right;
      color: #999;
      padding-right: 8px;
      margin-right: 8px;
      border-right: 1px solid #ddd;
      font-family: monospace;
      font-size: 14px;
      min-width: 40px;
    }
    
    .line-content {
      flex: 1;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    
    /* Collapsible sections */
    .collapse-section {
      background-color: #f0f0f0;
      border-radius: 3px;
      margin: 2px 0;
      cursor: pointer;
    }
    
    .collapse-section:hover {
      background-color: #e5e5e5;
    }
    
    .collapse-content {
      display: none;
    }
    
    .collapse-header {
      padding: 4px 8px;
      font-weight: bold;
      color: #666;
      display: flex;
      align-items: center;
    }
    
    .collapse-header:before {
      content: "▶";
      margin-right: 6px;
      font-size: 10px;
    }
    
    .expanded .collapse-header:before {
      content: "▼";
    }
    
    .expanded .collapse-content {
      display: block;
    }
    .btn-disabled {
      background: #cccccc;
      color: #666666;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .btn-disabled:hover {
      background: #cccccc;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>JSON Diff Page (with Validation)</h1>

  <div class="section">
    <h2>1. Fetch AdConfig from backend</h2>
    <div class="api-inputs">
      <div>
        <label>app_id: </label>
        <select id="appIdSelect" class="api-select">
          <option value="1">1 - Demo App</option>
          <!-- Future options can be added here -->
        </select>
      </div>
      <div>
        <label>org_id: </label>
        <select id="orgIdSelect" class="api-select">
          <option value="1061">1061 - Demo Organization</option>
          <!-- Future options can be added here -->
        </select>
      </div>
    </div>

    <button class="btn" id="fetchBtn">Fetch AdConfig</button>
    <div style="margin-top:10px;">
      <strong>Raw Response:</strong>
      <div class="raw-response" id="rawResponse"></div>
    </div>
  </div>

  <div class="section">
    <h2>2. Edit AdConfig</h2>
    <div class="collapse-controls">
      <button class="btn" id="expandAllBtn">Expand All</button>
      <button class="btn" id="collapseAllBtn">Collapse All</button>
    </div>
    <div id="adConfigFormContainer"></div>
    <button class="btn" id="generateBtn">Generate New JSON & Diff</button>
  </div>

  <div class="section">
    <h2>Validation Result</h2>
    <div id="validationResult"></div>
  </div>

  <div class="section">
    <h2>3. New & Old JSON Diff</h2>
    <div class="diff-actions">
      <button class="btn" id="expandAllDiffBtn">Expand All Sections</button>
      <button class="btn" id="collapseAllDiffBtn">Collapse All Sections</button>
    </div>
    <div class="diff-container">
      <div class="diff-side">
        <h3>Original JSON</h3>
        <div class="diff-markers-container" id="leftDiffMarkers"></div>
        <pre id="originalJson" class="json-display"></pre>
      </div>
      <div class="diff-side">
        <h3>Modified JSON</h3>
        <div class="diff-markers-container" id="rightDiffMarkers"></div>
        <pre id="modifiedJson" class="json-display"></pre>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>4. Review & Approve</h2>
    <div class="review-inputs">
      <div>
        <label>app_id: </label>
        <select id="reviewAppIdSelect" class="api-select">
          <option value="1">1 - Demo App</option>
          <!-- Future options can be added here -->
        </select>
      </div>
      <div>
        <label>org_id: </label>
        <select id="reviewOrgIdSelect" class="api-select">
          <option value="1061">1061 - Demo Organization</option>
          <!-- Future options can be added here -->
        </select>
      </div>
    </div>
    <button class="btn" id="approveBtn">Approve Changes</button>
    <div id="approveResult" class="approve-result"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>

<script>
const CONFIG = {
  apps: [
    { id: 1, name: "Demo App" }
    // <!-- Future options can be added here -->
  ],
  orgs: [
    { id: 1061, name: "Demo Organization" }
    // <!-- Future options can be added here -->
  ]
};

const TOKEN_MAP = {
  // format: "app_id-org_id": "token"
  "1-1061": "af7ce3f9-462d-4df1-815f-09314bb87ca3"
  // <!-- Future options can be added here -->
};

// get token by app_id and org_id
function getToken(appId, orgId) {
  const key = `${appId}-${orgId}`;
  const token = TOKEN_MAP[key];
  
  if (!token) {
    throw new Error(`No token found for app_id=${appId}, org_id=${orgId}. Please configure this combination.`);
  }
  
  return token;
}

// initialize UI
function initUI() {
  // Populate app_id dropdown
  const appIdSelect = document.getElementById('appIdSelect');
  appIdSelect.innerHTML = ''; // Clear existing options
  const defaultAppOption = document.createElement('option');
  defaultAppOption.value = '';
  defaultAppOption.textContent = 'Select App ID';
  appIdSelect.appendChild(defaultAppOption);
  
  CONFIG.apps.forEach(app => {
    const option = document.createElement('option');
    option.value = app.id;
    option.textContent = `${app.id} - ${app.name}`;
    appIdSelect.appendChild(option);
  });

  // Populate org_id dropdown
  const orgIdSelect = document.getElementById('orgIdSelect');
  orgIdSelect.innerHTML = ''; // Clear existing options
  const defaultOrgOption = document.createElement('option');
  defaultOrgOption.value = '';
  defaultOrgOption.textContent = 'Select Org ID';
  orgIdSelect.appendChild(defaultOrgOption);
  
  CONFIG.orgs.forEach(org => {
    const option = document.createElement('option');
    option.value = org.id;
    option.textContent = `${org.id} - ${org.name}`;
    orgIdSelect.appendChild(option);
  });

  // when init, sync the value of two dropdowns
  document.getElementById('reviewAppIdSelect').value = '';
  document.getElementById('reviewOrgIdSelect').value = '';
}

/*************************************************************
 * 1) Validate AdConfig Logic
 *    reference the validation rules you provided, but modified to accept a JSON string parameter
 *************************************************************/
function validateAdConfig(adConfigString) {
  const errors = [];
  let jsonData;

  // directly use JSON.parse(), because the JSON.stringify() generated string doesn't need extra escape
  try {
    jsonData = JSON.parse(adConfigString);
  } catch (e) {
    errors.push(`JSON parsing failed: ${e.message}`);
    return errors;
  }

  // necessary fields check
  if (typeof jsonData.orgId !== "number") {
    errors.push("orgId must be a number.");
  }
  if (typeof jsonData.appId !== "number") {
    errors.push("appId must be a number.");
  }
  if (typeof jsonData.bundle !== "string") {
    errors.push("bundle must be a string.");
  }
  if (!Array.isArray(jsonData.placements)) {
    errors.push("placements must be an array.");
  }

    // placements further check
  if (Array.isArray(jsonData.placements)) {
    jsonData.placements.forEach((placement, pIndex) => {
      if (typeof placement.placement_id !== "string") {
        errors.push(`placements[${pIndex}].placement_id must be a string.`);
      }
      if (typeof placement.auction_timeout !== "number") {
        errors.push(`placements[${pIndex}].auction_timeout must be a number.`);
      }
      if (!Array.isArray(placement.bidders)) {
        errors.push(`placements[${pIndex}].bidders must be an array.`);
      } else {
        placement.bidders.forEach((bidder, bIndex) => {
          if (typeof bidder.name !== "string") {
            errors.push(`placements[${pIndex}].bidders[${bIndex}].name must be a string.`);
          }
          if (typeof bidder.bidder_placement_id !== "string") {
            errors.push(`placements[${pIndex}].bidders[${bIndex}].bidder_placement_id must be a string.`);
          }
          if (bidder.hasOwnProperty("bidder_format") && typeof bidder.bidder_format !== "string") {
            errors.push(`placements[${pIndex}].bidders[${bIndex}].bidder_format must be a string.`);
          }
          if (bidder.hasOwnProperty("params")) {
            if (typeof bidder.params !== "object" || bidder.params === null) {
              errors.push(`placements[${pIndex}].bidders[${bIndex}].params must be an object.`);
            } else {
              // if there is price, it must be a number
              if (bidder.params.hasOwnProperty("price")) {
                const priceValue = Number(bidder.params.price); // Convert to number
                if (isNaN(priceValue)) {
                  errors.push(`placements[${pIndex}].bidders[${bIndex}].params.price must be a valid number.`);
                }
              }
            }
          }
        });
      }
    });
  }

  return errors;
}

/*************************************************************
 * 2) JSON Diff Page Logic
 *************************************************************/

// Add this global variable to store collapse states
window._collapsedPaths = new Set();

/** a) Fetch AdConfig from server */
async function fetchAdConfig() {
  const appId = document.getElementById('appIdSelect').value;
  const orgId = document.getElementById('orgIdSelect').value;
  
  try {
    // get token from token map
    const token = getToken(appId, orgId);
    
    const payload = {
      app_id: Number(appId),
      org_id: Number(orgId),
      token: token
    };
    
    const resp = await fetch('http://localhost:3000/api/proxy/getAdConfig', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(`HTTP error ${resp.status}: ${error.message || 'Unknown error'}`);
    }
    
    const data = await resp.json();
    console.log('API response data:', data);
    
    // first process the raw_response and show it
    document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
    
    // check if there is ad_config_settings
    if (!data.ad_config_settings || !data.ad_config_settings.ad_config) {
      throw new Error('Invalid response format: missing ad_config_settings.ad_config');
    }
    
    // get ad_config string and parse it to object
    const adConfigStr = data.ad_config_settings.ad_config;
    
    // important modification: correctly handle the JSON string that may contain escape characters
    let adConfigObj;
    try {
      // parse the JSON string to object
      adConfigObj = JSON.parse(adConfigStr);
      
      // reformat to a unified format, remove the influence of escape characters
      const formattedAdConfigStr = JSON.stringify(adConfigObj, null, 2);
      
      // save the formatted string and object, for later operations
      window._originalAdConfigStr = formattedAdConfigStr;
      window._originalAdConfigObj = adConfigObj;
      
      // render the editable form
      const formContainer = document.getElementById('adConfigFormContainer');
      formContainer.innerHTML = '';
      renderFormFromJSON(adConfigObj, formContainer);
      
      // initialize the collapsed state tracker
      window._collapsedPaths = new Set();
    } catch (e) {
      console.error('Error parsing ad_config JSON:', e);
      throw new Error(`Failed to parse ad_config: ${e.message}`);
    }
    
  } catch (err) {
    alert(`Error fetching AdConfig: ${err.message}`);
    console.error('Fetch error:', err);
  }
}

/** b) recursive render the form */
function renderFormFromJSON(jsonValue, parentEl, keyPath = []) {
  if (Array.isArray(jsonValue)) {
    // handle array
    const arrayDiv = document.createElement('div');
    arrayDiv.className = 'array-block';
    
    // add toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-btn';
    toggleBtn.textContent = '▼';
    toggleBtn.onclick = (e) => {
      e.stopPropagation();
      toggleCollapse(toggleBtn.parentElement);
    };
    parentEl.appendChild(toggleBtn);
    
    // add placeholder (show when collapsed)
    const placeholder = document.createElement('span');
    placeholder.className = 'placeholder';
    placeholder.textContent = `[Array: ${jsonValue.length} items]`;
    parentEl.appendChild(placeholder);
    
    // Add special handling for empty arrays
    if (jsonValue.length === 0) {
      const emptyMsg = document.createElement('span');
      emptyMsg.textContent = '(Empty Array)';
      emptyMsg.style.fontStyle = 'italic';
      emptyMsg.style.color = '#666';
      arrayDiv.appendChild(emptyMsg);
    } else {
      // Only create the indented items if array has elements
      jsonValue.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'field-block';
        
        // show index
        const label = document.createElement('label');
        label.textContent = `[${index}]`;
        itemDiv.appendChild(label);

        // remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = '-';
        removeBtn.onclick = () => {
          if (confirm(`Are you sure you want to delete item at index [${index}]?`)) {
            jsonValue.splice(index, 1);
            
            // Save collapsed states before rebuilding
            const collapsedStates = window._collapsedPaths;
            
            // Rebuild the form
            if (keyPath.length > 0) {
              const parentContainer = document.getElementById('adConfigFormContainer');
              parentContainer.innerHTML = '';
              renderFormFromJSON(window._originalAdConfigObj, parentContainer);
            } else {
              arrayDiv.innerHTML = '';
              renderFormFromJSON(jsonValue, arrayDiv, keyPath);
            }
            
            // Restore collapsed states
            applyCollapsedStates();
          }
        };
        itemDiv.appendChild(removeBtn);

        // recursive render inner
        renderFormFromJSON(item, itemDiv, keyPath.concat(index));
        arrayDiv.appendChild(itemDiv);
      });
    }

    // add new element
    const addBtn = document.createElement('button');
    addBtn.className = 'add-btn';
    addBtn.textContent = 'Add Item inside []';
    addBtn.onclick = () => {
      jsonValue.push({});
      
      // Save collapsed states before rebuilding
      const collapsedStates = window._collapsedPaths;
      
      // Rebuild the form
      if (keyPath.length > 0) {
        const parentContainer = document.getElementById('adConfigFormContainer');
        parentContainer.innerHTML = '';
        renderFormFromJSON(window._originalAdConfigObj, parentContainer);
      } else {
        arrayDiv.innerHTML = '';
        renderFormFromJSON(jsonValue, arrayDiv, keyPath);
      }
      
      // Restore collapsed states
      applyCollapsedStates();
    };
    arrayDiv.appendChild(addBtn);

    parentEl.appendChild(arrayDiv);

  } else if (typeof jsonValue === 'object' && jsonValue !== null) {
    // handle object
    const objDiv = document.createElement('div');
    objDiv.className = 'object-block';
    
    // add toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'toggle-btn';
    toggleBtn.textContent = '▼';
    toggleBtn.onclick = (e) => {
      e.stopPropagation();
      toggleCollapse(toggleBtn.parentElement);
    };
    parentEl.appendChild(toggleBtn);
    
    // add placeholder (show when collapsed)
    const placeholder = document.createElement('span');
    placeholder.className = 'placeholder';
    placeholder.textContent = `{Object: ${Object.keys(jsonValue).length} properties}`;
    parentEl.appendChild(placeholder);

    Object.keys(jsonValue).forEach((k) => {
      const val = jsonValue[k];
      const fieldDiv = document.createElement('div');
      fieldDiv.className = 'field-block';

      // label
      const labelSpan = document.createElement('span');
      labelSpan.className = 'field-label';
      labelSpan.textContent = k + ':';
      fieldDiv.appendChild(labelSpan);

      // remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '-';
      removeBtn.onclick = () => {
        if (confirm(`Are you sure you want to delete field "${k}"?`)) {
          delete jsonValue[k];
          
          // Save collapsed states before rebuilding
          const collapsedStates = window._collapsedPaths;
          
          // Rebuild the form
          if (keyPath.length > 0) {
            const parentContainer = document.getElementById('adConfigFormContainer');
            parentContainer.innerHTML = '';
            renderFormFromJSON(window._originalAdConfigObj, parentContainer);
          } else {
            objDiv.innerHTML = '';
            renderFormFromJSON(jsonValue, objDiv, keyPath);
          }
          
          // Restore collapsed states
          applyCollapsedStates();
        }
      };
      fieldDiv.appendChild(removeBtn);

      // recursive or basic type
      if (typeof val === 'object' && val !== null) {
        renderFormFromJSON(val, fieldDiv, keyPath.concat(k));
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = val;
        input.style.width = '300px';
        input.onchange = input.onblur = input.oninput = (e) => {
          jsonValue[k] = e.target.value;
          
          // Try to convert to number if it looks like a number
          if (!isNaN(e.target.value) && e.target.value.trim() !== '') {
            jsonValue[k] = Number(e.target.value);
          }
        };
        fieldDiv.appendChild(input);
      }

      objDiv.appendChild(fieldDiv);
    });

    // add new field
    const addFieldBtn = document.createElement('button');
    addFieldBtn.className = 'add-btn';
    addFieldBtn.textContent = 'Add Field inside {}';
    addFieldBtn.onclick = () => {
      const newKey = prompt('Please input the key of the new field:');
      if (newKey && !jsonValue.hasOwnProperty(newKey)) {
        jsonValue[newKey] = '';
        
        // Save collapsed states before rebuilding
        const collapsedStates = window._collapsedPaths;
        
        // Rebuild the form
        if (keyPath.length > 0) {
          const parentContainer = document.getElementById('adConfigFormContainer');
          parentContainer.innerHTML = '';
          renderFormFromJSON(window._originalAdConfigObj, parentContainer);
        } else {
          objDiv.innerHTML = '';
          renderFormFromJSON(jsonValue, objDiv, keyPath);
        }
        
        // Restore collapsed states
        applyCollapsedStates();
      }
    };
    objDiv.appendChild(addFieldBtn);

    parentEl.appendChild(objDiv);

  } else {
    // basic type
    const input = document.createElement('input');
    input.type = 'text';
    input.value = jsonValue !== null ? jsonValue : '';
    input.style.width = '300px';
    input.onchange = input.onblur = input.oninput = (e) => {
      jsonValue[k] = e.target.value;
      
      // Try to convert to number if it looks like a number
      if (!isNaN(e.target.value) && e.target.value.trim() !== '') {
        jsonValue[k] = Number(e.target.value);
      }
    };
    parentEl.appendChild(input);
  }
}

// Update toggleCollapse function to track state
function toggleCollapse(element) {
  element.classList.toggle('collapsed');
  
  // Get the path for this element
  const path = getElementPath(element);
  
  // Track collapsed state
  if (element.classList.contains('collapsed')) {
    window._collapsedPaths.add(path);
  } else {
    window._collapsedPaths.delete(path);
  }
  
  // Update button icon
  const toggleBtn = element.querySelector(':scope > .toggle-btn');
  if (toggleBtn) {
    toggleBtn.textContent = element.classList.contains('collapsed') ? '▶' : '▼';
  }
}

// Get a "path" for an element based on its position in the form
function getElementPath(element) {
  const pathParts = [];
  let current = element;
  let parent = current.parentElement;
  
  while (parent && parent.id !== 'adConfigFormContainer') {
    const children = Array.from(parent.children);
    const index = children.indexOf(current);
    pathParts.unshift(index);
    current = parent;
    parent = current.parentElement;
  }
  
  return pathParts.join('-');
}

// Apply collapsed states after rebuilding the form
function applyCollapsedStates() {
  // Only proceed if we have saved states
  if (!window._collapsedPaths || window._collapsedPaths.size === 0) return;
  
  const container = document.getElementById('adConfigFormContainer');
  
  // Process each collapsible element
  const toggleButtons = container.querySelectorAll('.toggle-btn');
  toggleButtons.forEach(btn => {
    const parent = btn.parentElement;
    const path = getElementPath(parent);
    
    // If this path was collapsed before, collapse it again
    if (window._collapsedPaths.has(path)) {
      parent.classList.add('collapsed');
      btn.textContent = '▶';
    }
  });
}

// Update the expandAll and collapseAll functions to track state
function expandAll() {
  const container = document.getElementById('adConfigFormContainer');
  const toggleButtons = container.querySelectorAll('.toggle-btn');
  toggleButtons.forEach(btn => {
    const parent = btn.parentElement;
    if (parent.classList.contains('collapsed')) {
      parent.classList.remove('collapsed');
      btn.textContent = '▼';
      // Remove from collapsed paths
      window._collapsedPaths.delete(getElementPath(parent));
    }
  });
}

function collapseAll() {
  const container = document.getElementById('adConfigFormContainer');
  const toggleButtons = container.querySelectorAll('.toggle-btn');
  toggleButtons.forEach(btn => {
    const parent = btn.parentElement;
    if (!parent.classList.contains('collapsed')) {
      parent.classList.add('collapsed');
      btn.textContent = '▶';
      // Add to collapsed paths
      window._collapsedPaths.add(getElementPath(parent));
    }
  });
}

/** c) Generate New JSON & Validate & Diff */
function onGenerateNewJSON() {
  try {
    const validationEl = document.getElementById('validationResult');
    validationEl.innerHTML = ''; // clear the last validation result
    
    // Clear diff areas immediately when regenerating
    document.getElementById('originalJson').innerHTML = '';
    document.getElementById('modifiedJson').innerHTML = '';
    document.getElementById('leftDiffMarkers').innerHTML = '';
    document.getElementById('rightDiffMarkers').innerHTML = '';
    
    // Disable approve button by default when regenerating
    const approveBtn = document.getElementById('approveBtn');
    approveBtn.disabled = true;
    approveBtn.classList.add('btn-disabled');

    if (!window._originalAdConfigObj) {
      alert('No original ad_config found.');
      return;
    }

    // 1. generate new JSON string
    const newObj = window._originalAdConfigObj;  // the object has been modified
    const newStr = JSON.stringify(newObj, null, 2);  // formatted JSON
    
    // save the new JSON string
    window._newAdConfigStr = newStr;

    // 2. validate first
    const errors = validateAdConfig(newStr);

    if (errors.length > 0) {
      // if validation failed, show the error info and skip the diff
      validationEl.innerHTML = `
        <div class="error">Validation failed. Please check the following errors:</div>
        <div class="error-list">${errors.join("<br>")}</div>
      `;
      // Keep approve button disabled when there are errors
      return;
    } else {
      // if validation passed, show the success info
      validationEl.innerHTML = `<div class="success">Validation successful: JSON structure and data types are correct!</div>`;
      
      // Enable approve button only when validation passes
      approveBtn.disabled = false;
      approveBtn.classList.remove('btn-disabled');
    }

    // 3. if validation passed, then execute the diff
    // parse and reformat the original JSON, to ensure the format consistency
    let oldObj, oldStr;
    try {
      // handle the possible escape characters
      if (window._originalAdConfigStr.includes('\\n')) {
        // the JSON string contains the escaped newline character, which means it has been formatted
        oldObj = JSON.parse(window._originalAdConfigStr);
      } else {
        // directly parse
        oldObj = JSON.parse(window._originalAdConfigStr);
      }
      // reformat, to ensure the format consistency
      oldStr = JSON.stringify(oldObj, null, 2);
    } catch (e) {
      console.error("Error parsing original JSON:", e);
      oldStr = window._originalAdConfigStr;
    }
    
    // update the JSON display on both sides
    updateSideBySideDiff(oldStr, newStr);
    
    // automatically fill the parameters in the Review area
    document.getElementById('reviewAppIdSelect').value = document.getElementById('appIdSelect').value;
    document.getElementById('reviewOrgIdSelect').value = document.getElementById('orgIdSelect').value;

    // Setup markers synchronization
    setupDiffMarkersSync();
  } catch (error) {
    console.error("Error generating JSON:", error);
    alert("An error occurred while generating the new JSON. See console for details.");
    
    // Keep approve button disabled on any error
    const approveBtn = document.getElementById('approveBtn');
    approveBtn.disabled = true;
    approveBtn.classList.add('btn-disabled');
  }
}

// implement the JSON diff display on both sides
function updateSideBySideDiff(oldJson, newJson) {
  const originalEl = document.getElementById('originalJson');
  const modifiedEl = document.getElementById('modifiedJson');
  
  // split content into lines
  const oldLines = oldJson.split('\n');
  const newLines = newJson.split('\n');
  
  // create line-by-line diff
  const diff = Diff.diffLines(oldJson, newJson);
  
  // context lines to show before and after changes
  const contextLines = 3;
  
  // prepare HTML for both sides
  let leftHTML = '<div class="diff-with-line-numbers">';
  let rightHTML = '<div class="diff-with-line-numbers">';
  
  // add line number columns
  leftHTML += '<div class="line-numbers">';
  rightHTML += '<div class="line-numbers">';
  
  // add content columns
  let leftContent = '<div class="line-content">';
  let rightContent = '<div class="line-content">';
  
  // track line numbers
  let leftLineNum = 1;
  let rightLineNum = 1;
  
  // track diff locations
  const leftDiffs = [];
  const rightDiffs = [];
  
  // Process the diff to identify unchanged regions that can be collapsed
  let unchangedRegions = [];
  let currentRegion = null;
  let lastWasChange = false;
  
  diff.forEach((part, index) => {
    const lines = part.value.split('\n').filter(line => line !== '');
    
    if (!part.added && !part.removed) {
      // This is an unchanged part
      if (lines.length > 2 * contextLines) {
        // Long enough to collapse
        const showLinesStart = lines.slice(0, contextLines);
        const hiddenLines = lines.slice(contextLines, lines.length - contextLines);
        const showLinesEnd = lines.slice(lines.length - contextLines);
        
        // Add visible start lines
        showLinesStart.forEach(line => {
          leftContent += `<div class="line" id="left-line-${leftLineNum}">${escapeHtml(line)}</div>`;
          rightContent += `<div class="line" id="right-line-${rightLineNum}">${escapeHtml(line)}</div>`;
          leftHTML += `<div>${leftLineNum}</div>`;
          rightHTML += `<div>${rightLineNum}</div>`;
          leftLineNum++;
          rightLineNum++;
        });
        
        // Add collapsible section
        leftContent += `<div class="collapse-section" id="left-collapse-${leftLineNum}">
          <div class="collapse-header" onclick="toggleCollapse('left-collapse-${leftLineNum}')">
            ${hiddenLines.length} unchanged lines
          </div>
          <div class="collapse-content">`;
          
        rightContent += `<div class="collapse-section" id="right-collapse-${rightLineNum}">
          <div class="collapse-header" onclick="toggleCollapse('right-collapse-${rightLineNum}')">
            ${hiddenLines.length} unchanged lines
          </div>
          <div class="collapse-content">`;
        
        // Add line numbers for hidden section
        hiddenLines.forEach(() => {
          leftHTML += `<div class="hidden-line-num">${leftLineNum}</div>`;
          rightHTML += `<div class="hidden-line-num">${rightLineNum}</div>`;
          leftLineNum++;
          rightLineNum++;
        });
        
        // Add hidden content
        hiddenLines.forEach(line => {
          leftContent += `<div class="line">${escapeHtml(line)}</div>`;
          rightContent += `<div class="line">${escapeHtml(line)}</div>`;
        });
        
        // Close collapsible section
        leftContent += `</div></div>`;
        rightContent += `</div></div>`;
        
        // Add visible end lines
        showLinesEnd.forEach(line => {
          leftContent += `<div class="line" id="left-line-${leftLineNum}">${escapeHtml(line)}</div>`;
          rightContent += `<div class="line" id="right-line-${rightLineNum}">${escapeHtml(line)}</div>`;
          leftHTML += `<div>${leftLineNum}</div>`;
          rightHTML += `<div>${rightLineNum}</div>`;
          leftLineNum++;
          rightLineNum++;
        });
      } else {
        // Too short to collapse, show all lines
        lines.forEach(line => {
          leftContent += `<div class="line" id="left-line-${leftLineNum}">${escapeHtml(line)}</div>`;
          rightContent += `<div class="line" id="right-line-${rightLineNum}">${escapeHtml(line)}</div>`;
          leftHTML += `<div>${leftLineNum}</div>`;
          rightHTML += `<div>${rightLineNum}</div>`;
          leftLineNum++;
          rightLineNum++;
        });
      }
      lastWasChange = false;
    } else if (part.added) {
      // Added lines - show in right panel only
      lines.forEach(line => {
        rightContent += `<div class="line diff-added" id="right-line-${rightLineNum}">${escapeHtml(line)}</div>`;
        rightHTML += `<div>${rightLineNum}</div>`;
        rightDiffs.push(rightLineNum);
        rightLineNum++;
      });
      lastWasChange = true;
    } else if (part.removed) {
      // Removed lines - show in left panel only
      lines.forEach(line => {
        leftContent += `<div class="line diff-removed" id="left-line-${leftLineNum}">${escapeHtml(line)}</div>`;
        leftHTML += `<div>${leftLineNum}</div>`;
        leftDiffs.push(leftLineNum);
        leftLineNum++;
      });
      lastWasChange = true;
    }
  });
  
  // Close HTML structures
  leftContent += '</div>';
  rightContent += '</div>';
  leftHTML += '</div>';
  rightHTML += '</div>';
  
  // Set HTML
  originalEl.innerHTML = leftHTML + leftContent;
  modifiedEl.innerHTML = rightHTML + rightContent;
  
  // Create diff markers
  createDiffMarkers('leftDiffMarkers', originalEl, leftDiffs, 'removed');
  createDiffMarkers('rightDiffMarkers', modifiedEl, rightDiffs, 'added');
}

// Toggle collapse sections
function toggleCollapse(id) {
  const element = document.getElementById(id);
  if (element) {
    element.classList.toggle('expanded');
  }
}

// Escape HTML to safely render in the diff
function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// Make the toggleCollapse function globally available
window.toggleCollapse = toggleCollapse;

// Create markers on the scrollbar for diffs
function createDiffMarkers(containerId, contentEl, diffPositions, diffType) {
  const container = document.getElementById(containerId);
  container.innerHTML = ''; // Clear existing markers
  
  if (diffPositions.length === 0) return;
  
  // Get important measurements
  const totalHeight = contentEl.scrollHeight;
  const viewportHeight = contentEl.clientHeight;
  const scrollbarTrackHeight = viewportHeight; // The height of the scrollbar track
  
  // Calculate the ratio of viewport to total content
  const viewportRatio = viewportHeight / totalHeight;
  
  diffPositions.forEach((lineNum) => {
    const lineEl = document.getElementById(`${containerId === 'leftDiffMarkers' ? 'left' : 'right'}-line-${lineNum}`);
    if (!lineEl) return;
    
    // Calculate the position of this line in the full content
    const linePos = lineEl.offsetTop;
    const lineRatio = linePos / totalHeight;
    
    // Create a marker
    const marker = document.createElement('div');
    marker.className = `diff-marker ${diffType}`;
    
    // Position the marker proportionally along the scrollbar track
    // This calculation takes into account the scrollable area vs viewport size
    marker.style.top = `${lineRatio * scrollbarTrackHeight}px`;
    
    marker.setAttribute('data-line', lineNum);
    marker.setAttribute('title', `${diffType === 'added' ? 'Addition' : 'Removal'} (click to navigate)`);
    
    // Add click handler to scroll to this diff
    marker.addEventListener('click', () => {
      // When clicking the marker, scroll to the exact position in the content
      contentEl.scrollTop = linePos - viewportHeight / 2;
      
      // Highlight the target line
      lineEl.classList.add('diff-highlight');
      setTimeout(() => {
        lineEl.classList.remove('diff-highlight');
      }, 2000);
    });
    
    container.appendChild(marker);
  });
  
  // Update markers when scrolling (optional, but helps with very long documents)
  contentEl.addEventListener('scroll', () => {
    updateMarkerVisibility(container, contentEl);
  });
}

// Update markers visibility based on scroll position
function updateMarkerVisibility(markerContainer, contentEl) {
  const scrollRatio = contentEl.scrollTop / (contentEl.scrollHeight - contentEl.clientHeight);
  const viewportRatio = contentEl.clientHeight / contentEl.scrollHeight;
  
  // Only update if we have substantial content (requiring scrolling)
  if (viewportRatio < 0.9) {
    markerContainer.style.top = `${scrollRatio * (1 - viewportRatio) * 100}%`;
  }
}

// Add a helper function to reposition markers when the panel is resized
function repositionDiffMarkers() {
  const originalJson = document.getElementById('originalJson');
  const modifiedJson = document.getElementById('modifiedJson');
  
  // Get all diff lines
  const leftDiffs = Array.from(document.querySelectorAll('.diff-removed'))
    .map(el => {
      const id = el.id;
      if (id) return parseInt(id.replace('left-line-', ''));
      return null;
    }).filter(id => id !== null);
    
  const rightDiffs = Array.from(document.querySelectorAll('.diff-added'))
    .map(el => {
      const id = el.id;
      if (id) return parseInt(id.replace('right-line-', ''));
      return null;
    }).filter(id => id !== null);
  
  // Recreate the markers with updated positions
  createDiffMarkers('leftDiffMarkers', originalJson, leftDiffs, 'removed');
  createDiffMarkers('rightDiffMarkers', modifiedJson, rightDiffs, 'added');
}

// Setup window resize listener to reposition markers
window.addEventListener('resize', debounce(repositionDiffMarkers, 100));

// Simple debounce function to prevent too many resize events
function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this;
    const args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

async function approveChanges() {
  const approveResultEl = document.getElementById('approveResult');
  approveResultEl.className = 'approve-result';
  approveResultEl.textContent = 'Submitting changes...';
  
  const appId = document.getElementById('reviewAppIdSelect').value;
  const orgId = document.getElementById('reviewOrgIdSelect').value;
  
  try {
    // get token from the token map
    const token = getToken(appId, orgId);
    
    // ensure there is a new JSON
    if (!window._originalAdConfigObj) {
      approveResultEl.className = 'approve-result approve-error';
      approveResultEl.textContent = 'Error: No AdConfig object found. Please fetch an AdConfig first.';
      return;
    }
    
    // create a compact JSON string (no extra spaces and newline characters)
    const compactJsonStr = JSON.stringify(window._originalAdConfigObj);
    
    // build the request parameters
    const payload = {
      ad_config_settings: {
        ad_config: compactJsonStr,
        app_id: Number(appId),
        org_id: Number(orgId)
      },
      token: token
    };
    
    // send the API request
    const resp = await fetch('http://localhost:3000/api/proxy/saveAdConfig', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    const data = await resp.json();
    
    if (!resp.ok) {
      throw new Error(`HTTP status ${resp.status}: ${data.message || 'Unknown error'}`);
    }
    
    // show the success info
    approveResultEl.className = 'approve-result approve-success';
    approveResultEl.innerHTML = `
      <div>Changes approved successfully!</div>
      <div>Code: ${data.code}</div>
      <div>Message: ${data.message}</div>
    `;
  } catch (err) {
    // show the error info
    approveResultEl.className = 'approve-result approve-error';
    approveResultEl.textContent = `Error: ${err.message}`;
  }
}

/** e) event binding */
document.getElementById('fetchBtn').addEventListener('click', fetchAdConfig);
document.getElementById('generateBtn').addEventListener('click', onGenerateNewJSON);
document.getElementById('expandAllBtn').addEventListener('click', expandAll);
document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
document.getElementById('approveBtn').addEventListener('click', approveChanges);

// initialize the UI after the page loaded
document.addEventListener('DOMContentLoaded', initUI);

// add event handlers for the expand/collapse all buttons
document.getElementById('expandAllDiffBtn').addEventListener('click', function() {
  const collapseSections = document.querySelectorAll('.collapse-section');
  collapseSections.forEach(section => {
    section.classList.add('expanded');
  });
});

document.getElementById('collapseAllDiffBtn').addEventListener('click', function() {
  const collapseSections = document.querySelectorAll('.collapse-section');
  collapseSections.forEach(section => {
    section.classList.remove('expanded');
  });
});

// add this function to synchronize the diff markers
function setupDiffMarkersSync() {
  const originalEl = document.getElementById('originalJson');
  const modifiedEl = document.getElementById('modifiedJson');

  // Synchronize scrolling between the two panels
  originalEl.addEventListener('scroll', function() {
    modifiedEl.scrollTop = originalEl.scrollTop;
    
    // Update markers on scroll
    updateMarkerVisibility(document.getElementById('leftDiffMarkers'), originalEl);
    updateMarkerVisibility(document.getElementById('rightDiffMarkers'), modifiedEl);
  });

  modifiedEl.addEventListener('scroll', function() {
    originalEl.scrollTop = modifiedEl.scrollTop;
    
    // Update markers on scroll
    updateMarkerVisibility(document.getElementById('leftDiffMarkers'), originalEl);
    updateMarkerVisibility(document.getElementById('rightDiffMarkers'), modifiedEl);
  });
}
</script>
</body>
</html>
